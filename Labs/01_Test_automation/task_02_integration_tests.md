# Задача 02. Интеграционные тесты

## Общая постановка
В этой задаче мы пишем интеграционные тесты для раздела "Категории" в приложении [NorthwindApp](NorthwindApp) и, по необходимости, вносим доработки в само приложение

## Детальные требования
### Тесты
#### Интеграционные тесты категорий
Доработать (расширить) класс **CategoriesControllerIntegrationTesting**:
- Обеспечить покрытие тестами всех Actions контроллера Categories
- Тесты покрывают весь pipeline работы приложения, т.е. эмулируют полноценный HTTP-запрос и получают HTTP-ответ (в зависимости от того, что за метод тестируется, ответы могут различаться - от получения полноценной HTML или файла с изображением, до просто ответа с ошибкой)
- Протестировать необходимо: 
    - положительные сценарии (создание и изменение категории, удаление, ...)
    - сценарии с ошибками (нарушение валидации, попытка удаления категории с привязанными продуктами, у категории нет картинки, ...)

Доработать связку **категория-продукты**
- В контроллере категорий показывать информацию о привязанных к категории продуктах:
    - общее количество привязанных продуктов и часть из них (названия первых 3-х)
    - эта информация (в том или ином виде) должна быть видна:
        - в детальной информации (Details)
        - при удалении категории
        - в сообщении об ошибке удаления
- Доработать генерацию тестовых данных - реализовать генератор продуктов (по аналогии с генератором категорий)

#### Приемочные тесты
Создать отдельный класс приемочных тестов, которые:
- работают с заранее развернутым и запущенным приложением (т.е. возиться с автоматическим деплоем и запуском приложения **не нужно!!!**)
- не используют генераторы кода, фабрику **WebApplicationFactory**, ...
- подключаются к серверу, используя обычный [HttpClient](https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient)
- в самих тестах используют только read-only сценарии:
    - получение Home страницы (проверить наличие ссылок)
    - получение списка категорий
    - получение деталей конкретной категории
    - ...
 
> Во всех сценариях можно считать, что тестовые данные берутся из текущего проекта **Northwind.DB**, однако, можно создать и свой тестовый набор при желании

---
## Развертывание и запуск приложения
Решение NorthwindApp включает 4 проекта
- **Northwind.DB** - проект базы данных
- **Northwind.Model** - классы моделей для базы + класс контекста для Entity Framework (**NorthwindContext**)
- **Northwind.Web** - само Web-приложение (реализовано как минимальное ASP.Net Core MVC приложение)
- **Northwind.Web.Tests** - тесты для проекта **Northwind.Web**

> Обратите внимание, что для запуска имеющихся тестов деплоить базу и запускать приложение не требуется. 
> 
> Однако, возможность запустить приложение чтобы "Просто поработать" будет весьма полезна а таже это требуется для написания приемочных тестов

Для запуска приложения необходимо собрать проект и задеплоить базу. 

Проект базы - это [SSDT-приложение](https://learn.microsoft.com/ru-ru/sql/ssdt/download-sql-server-data-tools-ssdt), поэтому для его развертывания нужно:
- установить компоненты для работы с данными в Visual Studio (см. по ссылке выше)
- убедиться, что у вас установдлн SQL-сервер (нас полностью устроит версия SQL Express LocalDB, которая ставится вместе с Visual Studio)

Для деплоя базы нужно: 
- открыть Solution
- на проекте **Northwind.DB** в контекстном меню выбрать **Publish...**
- в диалоге деплоя указать строку подключения к серверу и имя базы (Northwind)
- в дополнительных параметрах можно поставить галочку **Always re-create database** (это не обязательно, но удобно если вы хотите всегда после деплоя откатывать базу в исходное состояние)

> Если вы используете другой instance SQL Server или указали другое имя базы, то не забудьте поменять строку подключения (проект Northwind.Web, файл appsettings.json)

После этого достаточно запустить на исполнение проект Northwind.Web

## Замечания по реализации
### Проект Northwind.Web
Проект **Northwind.Web** - это сгенерированный стандартными средствами проект ASP.Net Core MVC с небольшими ручными доработками

Реализованы только 2 контроллера Home и Categories

Из важных изменений:
- Для передачи данных во View и для получения данных с клиента используется не класс **Category** из проекта моделей, а его копия **CategoryViewModel** (это позволило, например, сделать загрузку файлов одновременно с формой + разметить ViewModel атрибутами валидации, не трогая исходный класс, ...)
- в проекте отключены валидации на клиенте (частично, они всё же срабатывают - например, ограничение на длину поля ввода) и все валидации проходят на сервере
- в методе удаления сделана обработка ситуации, когда к категории привязаны продукты и при попытке удалить категорию срабатывает constraint по внешнему ключу

### Тесты
Интеграционные тесты в **CategoriesControllerIntegrationTesting** не требуют запуска внешних приложений и деплоя базы засчет:
- использования [In-memory провайдера для EF](https://learn.microsoft.com/en-us/ef/core/testing/testing-without-the-database#in-memory-provider) (см. его создание в **NorthwindContextHelpers**)
- использования **WebApplicationFactory** (подробнее можно прочитать в статье [Integration tests in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests), инициализацию в тестатх найти в методе **GetTestHttpClient**)
    - обратите внимание, для использования в тестах переданный **NorthwindContext** регистрируется как Singleton (хотя обычно рекомендуют это делать в режиме Scope, т.е. свой на каждый запрос). Если этого не сделать, то невозможно будет проводить тесты, состоящие из нескольких запросов

Для генерации тестовых данных используется генератор на базе [Bogus for .NET](https://github.com/bchavez/Bogus)