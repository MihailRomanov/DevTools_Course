# Задача 03. GitHub Actions

## Общая постановка
Продолжаем предыдущие задачи и автоматизируем 2 процесса:
- сборку и тестирование текущего кода
- выпуск релиза библиотеки (публикацию NuGet и создание Release на Github)


## Детальные требования

### Как отчитываться
Работа с Actions и правилами для Merge имеет ряд особенностей (например, Actions для ручного запуска должны всегд лежать в default branch, а правила на Merge не работают в приватных репозиториях на бесплатных аккаунтах).

Поэтому предлагается следующая схема работы:
- создается еще один репозиторий, аналогичный текущему (но нам нужны только проект `PowerCollections` и тесты, всё остальное, что было сделано в предудщих задачах, можно не брать)
- этот репозиторий делается публичным (можно не сразу, а только в момент, когда будете настраивать правила)
- в репозитории производится вся отладка workflow и правил
- файлы workflow и правила переносятся обратно репозиторий для лабораторной, в ветку для сдачи (`task03`)
- ветка `task03` временно делается веткой по умолчанию (чтобы запускать ручные workflow)
- делается демонстрационный пример:
    - в ветку `task03` вносится сначала коммит с ошибкой (так чтобы упала компиляция)
    - затем этот коммит исправляется
    - потом ошибка, чтобы не прошли тесты
    - снова исправляется
    - после чего запускается создание релиза с текущем номером версии
    - коммит с изменением номера версии и еще один релиз

Таким образом, в PR на прверку у вас должны попасть:
- коммит(ы) с вашими workflow
- коммиты с ошибками и исправлениями
- коммиты для релизов (когда менялась версия пакета)

Репозиторий, на котором всё обкатывалось в жтот момент можно удалить.


### Cборка и тестирование текущего кода
Создаем Github Workflow, которая:
- срабатывает на событие push
- извлекает последний коммит
- собирает и тестирует проект

Для настройки виртуалки и получения кода можно использовать
- [Action: Setup .NET Core SDK](https://github.com/marketplace/actions/setup-net-core-sdk)
- [Action: Checkout](https://github.com/marketplace/actions/checkout)

Для сборки и запуска тестов команды [dotnet CLI](https://learn.microsoft.com/ru-ru/dotnet/core/tools/dotnet):
- `restore`
- `build`
- `test`

**Важный момент**: если вы будуте запускать все на Linux-машине, могут возникнуть проблемы с прохождением части тестов. Связано это с особенностями настроек локали по умолчанию (для Linux используется не привязанная к языку, а под windows - от текущего языка)

Один из простых способов исправить - добавить в проект PowerCollections.Tests (например, в файл AssemblyInfo.cs) такой класс:

```C#
[TestClass]
public class CultureInitializer
{
    [AssemblyInitialize]
    public static void AssemblyInit(TestContext context)
    {
        CultureInfo.DefaultThreadCurrentUICulture = new CultureInfo("en-US");
        CultureInfo.DefaultThreadCurrentCulture = new CultureInfo("en-US");
    }
}
```

### Настройка правил мержа
Для ветки по-умолчанию (обычно `master` или `main`) настраиваем следующие права защиты:
- обезательно merge через Pull Request
- прохождение всех проверок (Status check) перед мержем
    - в качестве обязательной проверки указать Job из вашей Workflow, который запускает сборку и тестирование (он будет доступен в списке после хотябы одного прогона)


### Выпуск релиза библиотеки
Создаем ещё одну Github Workflow, которая:
- запускается вручную (тип события `workflow_dispatch`)
- также извлекает извлекает последний коммит (на той ветке где запущена - указанны выше `actions/checkout` именно так и работает)
- собирает nuget пакет
- публикует этот пакет в репозиторий GitHub
- создает релиз на GitHub, для которого:
    - в качестве артифакта указывается только что созданный nuget пакет
    - в качестве версии (и тэга) уазывается строка `v<номер_версии_пакета>` (например `v1.0.1`)

Для сборки пакета и его публикации можно использовать [dotnet CLI](https://learn.microsoft.com/ru-ru/dotnet/core/tools/dotnet):
- `pack`
- `nuget push`. Здесь обратите внимание, что в качестве API-ключа (параметр `--api-key`) для публикации (т.к. вы публикуете из текущего репозитория в тот же аккаунт) подойдет встроенный `${{ secrets.GITHUB_TOKEN }}`. А url для публикации вида `https://nuget.pkg.github.com/<имя_аккаунта>/index.json` можно указать прямо в параметре `--source`

Для остальных операций можно рассмотреть, например:
- для создания релизов [Action: Create Release](https://github.com/marketplace/actions/create-release) или аналогичный (их не мало)
- для получения номера версии чтением из .csproj-файла [Action: Get XML Info](https://github.com/marketplace/actions/get-xml-info) (вниательно посмотрите на пример, как именно там получают значение - отдельный шаг, а потом обращение к контексту `steps.<id_шага>.outputs.info`)

