# Задача 01. NuGet

## Общая постановка
В этой задаче мы сделаем из проекта [PowerCollections от Wintellect](../01_Test_automation/PowerCollections), который мы дорабатывали в прошлой лабораторной, NuGet пакет.
С этим пакетом мы также проделаем следующие манипуляции:
- настроим публикацию пакета во внешнее хранилище
- подключим пакет в новое приложение
- выпустим новую версию пакета

## Детальные требования

### Важные моменты
Для публикации мы будем использовать хранилище [GitHub Packages](https://docs.github.com/en/packages), которое может выступать, в том числе как хранилище [NuGet-пакетов](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry).

Вот несколько основных моментов, связанных с ним:
- все репозитории пакетов (также как репозитории кода) привязаны к персональным аккаунтам или организациям
- для доступа репозиторию используется URL вида **https://nuget.pkg.github.com/GitHub_аккаунт/index.json** (например, https://nuget.pkg.github.com/mihailromanov/index.json)
- любое обращение по указанному выше URL должно быть аутентифицированно. Для аутентификации используется пара аккаунт/PAT (personal access token). Как создать такой токен описывается в статье [Create a personal access token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token). Нам нужны токены с правами **packages:read** и **packages:write** (можно создать 2 разных токена для чтения и публикации пакета, а можно один на всё).
- прописать все эти настройки на компьютере можно командой
```
dotnet nuget add source --username <аккаунт> --password <PAT> --store-password-in-clear-text --name <имя_источника> <url_NuGet_репозитория>
```
например
```
dotnet nuget add source --username mihailromanov --password 123 --store-password-in-clear-text --name github_MR "https://nuget.pkg.github.com/mihailromanov/index.json"
```

*Можно, например, таким образом указать credentials на чтение, а публиковать с явным указанием PAT - см. ниже*

Возможно будет также полезной статья [Consuming a NuGet package from GitHub Packages](https://samlearnsazure.blog/2021/08/08/consuming-a-nuget-package-from-github-packages/)

### 01. Настройка генерации NuGet-пакета
Проверьте, что проект PowerCollections (без тестов) собирается в nuget-пакет командами
```
msbuild -t:pack
```
и 
```
dotnet pack
```

Более подробно о **dotnet pack** можно узнать [в документации](https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-pack)

Дополните проект метаданными (название, авторы, копирайт, ...)
Далеко не все из требуемых данных доступны в настройках через UI, поэтому рекомендую сразу же работать через редактирование файла проекта (**PowerCollections.csproj**)
Справочник по тегам для настройки NuGet-пакета можно найти [здесь](https://learn.microsoft.com/en-us/nuget/reference/msbuild-targets#pack-target) (см. колонку **MSBuild Property**)
Сами исходные метаданные проще всего взять из оригинального проекта (например, [тут](https://github.com/timdetering/Wintellect.PowerCollections/blob/master/Source/PowerCollections/AssemblyInfo.cs)).

Однако, часть полей нужно заполнить специальным образом:
- PackageId - укажите в формате <ваш_аккаунт_на_github>.PowerCollections (например, MihailRomanov.PowerCollections)
- версия. Составьте её из 2-х частей (**VersionPrefix** и **VersionSuffix**) так, чтобы получиалсь версия **0.0.1-beta**
- URL репозитория - ссылкой на ваш репозиторий (это нужно, чтобы пакет автоматически привязался к репозиторию и можно было от него нвследовать права)

Соберите новый пакет обоими способами и проверьте корректность заполнения

Добавьте в корень вашего solution файл **build_and_publish_nuget.cmd** (можно, если хотите использовать не CMD, а PowerShell), с командой сборки пакета в конфигурации **Release** (любой на ваше усмотрение)


### 02. Публикация пакета

Опубликуйте пакет в репозиторий
```
dotnet nuget push <путь_до_пакета>  --api-key <ваш_PAT> --source <имя_или_URL_источника>
```

Зайдите в браузере в ваш репозиторий с кодом, и проверьте, что на закладке **Code** в списке **Packages** виден ваш пакет (он должен там появиться, если вы на предыдущем шаге верно настроили URL репозитория для пакета)

Перейдите к настройкам пакета (не репозитория, а именно пакета!) и настройте в разделе **Manage access** наследование прав от репозитория кода

Добавьте строку для публикации пакета в файл **build_and_publish_nuget.cmd**

### 03. Использование пакета

Добавьте в ваш репозиторий новый Solution с консольным приложением.
В этом приложении подключите созданный вами пакет (обратите внимание, что он beta, поэтому при поиске его через NuGet нужно будет указывать **Include prerelease**).

В самом приложении напишите минимальный код, который создает стек (который вы делали в прошлой лабораторной) и заполняет его.

### 04. Обновление пакета

Выпустите и опубликйте новую версию пакета (например, 0.0.2-beta - если потребуются еще версии, просто увеличивайте последнюю цифровую часть), в которой по умолчанию стек будет создаваться размером 100.
Для сборки и публикации используйте файл **build_and_publish_nuget.cmd**

Перейдите в консольное приложение и обновите в нем версию вашего пакета. 


## Что должно быть в результате
- репозиторий исходного кода, в котором:
    - библиотека PowerCollection
    - приложение, которое эту библиотеку подключает как NuGet-пакет
- опубликованный NuGet-пакет из нескольких версий и привязанный к этому репозиторию
- файл **build_and_publish_nuget.cmd** который автоматизирует сборку релизной версии пакета и его публикацию (то, что там будет PAT - не очень хорошее решение, но пока остановимся на таком)